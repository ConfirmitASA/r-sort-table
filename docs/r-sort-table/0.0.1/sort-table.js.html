<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>sort-table.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="SortOrder.html">SortOrder</a><ul class='methods'><li data-type='method'><a href="SortOrder.html#add">add</a></li><li data-type='method'><a href="SortOrder.html#getCell">getCell</a></li><li data-type='method'><a href="SortOrder.html#remove">remove</a></li><li data-type='method'><a href="SortOrder.html#replace">replace</a></li></ul></li><li><a href="SortTable.html">SortTable</a><ul class='methods'><li data-type='method'><a href="SortTable.html#.listenForSort">listenForSort</a></li><li data-type='method'><a href="SortTable.html#.sorter">sorter</a></li><li data-type='method'><a href="SortTable.html#sort">sort</a></li></ul></li><li><a href="TableColumns.html">TableColumns</a><ul class='methods'><li data-type='method'><a href="TableColumns.html#.computeColumns">computeColumns</a></li><li data-type='method'><a href="TableColumns.html#.getDefaultHeaderRow">getDefaultHeaderRow</a></li><li data-type='method'><a href="TableColumns.html#.getHeader">getHeader</a></li><li data-type='method'><a href="TableColumns.html#.getHeaderCells">getHeaderCells</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="SortTable.html#~event:reportal-table-sort">reportal-table-sort</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">sort-table.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import ReportalBase from "r-reporal-base/src/reportal-base";
import TableColumns from "./table-columns";
import SortOrder from "./sort-order";

/**
 * Event reporting that a table has been sorted
 * @event SortTable~reportal-table-sort
 */

/**
 *
 * */
class SortTable {
  /**
   * Makes a table sortable, gives API for sorting. It sorts `data` array, but doesn't move rows in the `source` table, because of differences in implementation
   * @param {Object} options - options passed to configure the Sorting
   * @param {Boolean} options.enabled=false - enables sorting on a header of a table
   * @param {HTMLTableElement} options.source - source table sorting will be applied to
   * @param {HTMLTableElement} [options.refSource] - the floating header if any, will reflect and trigger sorting on header when scrolled.
   * @param {Number} [options.defaultHeaderRow=-1] - index of the row in `thead` (incremented from 0) that will have sorting enabled for columns. If `-1` then last row.
   * @param {Array} [options.columns] - Array of column indices (incremented from 0) that will have sorting enabled. If not specified, all columns will be sortable. Optionally `excludedColumns` can be specified instead as a shorthand to pass only indices of columns to be excluded from sorting, assumning that others will be made sortable. It's important to count the column index in the defaultHeaderRow
   * @param {Array} [options.excludedColumns] - Array of column indices (incremented from 0) that will be excluded from sorting. Can be used as a shorthand instead of `columns`.
   * @param {Object} [options.defaultSorting] - an array of objects that specify default sorting
   * @param {Number} options.defaultSorting.column - column index
   * @param {String} options.defaultSorting.direction - sort direction (`asc`|`desc`)
   * @param {Array} options.data - data with information for rows to be sorted
   * */

  constructor(options){
    let {enabled=false,source,refSource,defaultHeaderRow=-1,columns,excludedColumns,defaultSorting=[],data=[]}=options;
    this._sortEvent = ReportalBase.newEvent('reportal-table-sort');

    this.enabled=enabled;
    if(source){
      this.source=source;
    } else {
      throw new Error('`source` table is not specified for SortTable');
    }

    this.data = data;

    //let tableColumns= new TableColumns({source, refSource, defaultHeaderRow});
    // setup sort order and do initial default sorting
    let sortableColumns=SortTable.defineSortableColumns(new TableColumns({source, refSource, defaultHeaderRow}), columns, excludedColumns);
    this.sortOrder = new SortOrder(sortableColumns, SortTable.sort(), defaultSorting);
    [source,refSource].forEach(src=>SortTable.listenForSort(TableColumns.getHeader(src),sortableColumns, this.sortOrder));// set up listeners for headers

    //SortTable.sort(); //initial sorting if any
  }


  //{index:Number, title:String, colSpan:Number, cell: HTMLTableCellElement, ?refCell:HTMLTableCellElement}
  static defineSortableColumns(columns, included, excluded){
    return columns.map((column,index)=>{
      let sortable = (!(included &amp;&amp; included.indexOf(column.cell.cellIndex)==-1) || (excluded &amp;&amp; excluded.indexOf(index)==-1)); // is in columns and not in excluded,
      if(sortable){
        column.cell.classList.add('sortable');
        column.sortable = true;
      }
    })
  }

  /**
   * sets up listeners for column headers available for click
   * @param {HTMLElement} delegatedTarget - element that will receive clicks and see if they are valid, `thead` is recommended to boil down to header clicks only
   * @param {Array} columns - array of table columns from {@link SortTable#defineSortableColumns}
   * @param {Array} sortOrder - instance of {@link SortOrder}
   * @listens click
   * */
  static listenForSort(delegatedTarget, columns, sortOrder){
    delegatedTarget.addEventListener('click',e=>{
      // if it's a table cell, is in columns array and is sortable
      if((e.target.tagName == 'TD' || e.target.tagName == 'TH') &amp;&amp; columns.filter(col=>col.sortable).map(function(col){return col.column;}).indexOf(e.target)>-1){
        sortOrder.replace({column:e.target.cellIndex, direction: e.target.classList.contains('asc')?'desc':'asc'});
      }
    })
  }


  /**
   * Performs sorting. Can sort two columns if `sortOrder` has two items, the first of which has priority.
   * @fires SortTable~reportal-table-sort
   * */
  sort(){
    let sortOrder = this.sortOrder.sortOrder;
    if(sortOrder &amp;&amp; sortOrder.length>0){
      this.data.forEach((block,index,array)=>{
        block.sort((a, b)=>{ // sort rows
          if(sortOrder.length>1){
            return this.constructor.sorter(a[this.columns[sortOrder[0].column].index],b[this.columns[sortOrder[0].column].index], sortOrder[0].direction === 'desc' ? -1 : 1) || this.constructor.sorter(a[this.columns[sortOrder[1].column].index],b[this.columns[sortOrder[1].column].index], sortOrder[1].direction === 'desc' ? -1 : 1)
          } else {
            return this.constructor.sorter(a[this.columns[sortOrder[0].column].index],b[this.columns[sortOrder[0].column].index], sortOrder[0].direction === 'desc' ? -1 : 1);
          }
        });
      });
      this.columns[sortOrder[0].column].cell.dispatchEvent(this._sortEvent);
    }
  }

  /**
   * Function that performs case insensitive sorting in the array. It can distinguish between numbers, numbers as strings, HTML and plain strings
   * */
  static sorter(a,b,lesser){
    //let x = a[idx],y = b[idx];
    let regex = /[&lt;>]/g;
    if(regex.test(a) || regex.test(b)){ // if we need to sort elements that have HTML like links
      let tempEl1 = document.createElement('span'); tempEl1.innerHTML = a;
      a=tempEl1.textContent.trim();
      let tempEl2 = document.createElement('span'); tempEl2.innerHTML = b;
      b=tempEl2.textContent.trim();
    }
    if(!isNaN(a) &amp;&amp; !isNaN(b)){//they might be numbers or null
      if(a===null){return 1} else if(b===null){return -1}
      return a &lt;  b ? lesser :  a >  b ? -lesser : 0;
    }
    else if(!isNaN(parseFloat(a)) &amp;&amp; !isNaN(parseFloat(b))){ // they might be number strings
      return parseFloat(a) &lt;  parseFloat(b) ? lesser :  parseFloat(a) >  parseFloat(b) ? -lesser : 0;
    } else { //they might be simple strings
      return a.toLowerCase() &lt; b.toLowerCase() ? lesser : a.toLowerCase() > b.toLowerCase() ? -lesser : 0;
    }
  }

}

export default SortTable
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.1</a> on Wed Sep 14 2016 17:43:32 GMT+0300 (Russia TZ 2 Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
